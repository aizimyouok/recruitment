<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>채용 현황 관리 시스템</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
        .icon {
            display: inline-block;
            width: 24px;
            height: 24px;
            vertical-align: middle;
        }
        /* 모달 트랜지션용 */
        .modal-enter { opacity: 0; transform: scale(0.95); }
        .modal-enter-active { opacity: 1; transform: scale(1); transition: all 200ms ease-out; }
        .modal-exit { opacity: 1; transform: scale(1); }
        .modal-exit-active { opacity: 0; transform: scale(0.95); transition: all 200ms ease-in; }

        /* 사이드바 트랜지션 */
        .sidebar {
            transition: transform 0.3s ease-in-out;
        }
        /* 테이블 셀 줄바꿈 방지 */
        .table-cell-nowrap {
            white-space: nowrap;
        }
        /* 지원자 관리 필터 너비 */
        .filter-select {
            min-width: 120px;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useCallback } = React;

        // Firebase 초기화
        let db = null;
        let auth = null;
        const initFirebase = (config) => {
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(config);
                }
                db = firebase.firestore();
                auth = firebase.auth();
                return true;
            } catch (error) {
                console.error("Firebase 초기화 오류:", error);
                return false;
            }
        };

        // --- 아이콘 컴포넌트 ---
        const Icon = ({ name, size = 24, className = "" }) => {
            const icons = {
                'layout-dashboard': '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>',
                'briefcase': '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>',
                'plus-circle': '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>',
                'git-compare': '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="18" r="3"/><circle cx="6" cy="6" r="3"/><path d="M13 6h3a2 2 0 0 1 2 2v7"/><path d="M11 18H8a2 2 0 0 1-2-2V9"/></svg>',
                'trending-up': '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>',
                'line-chart': '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18"/><path d="M18 17l-5-5-4 4-4-4"/></svg>',
                'settings': '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 6v6m9.22-9.22l-4.24 4.24m-5.66 0L6.78 9.22m0 5.56l4.24-4.24m5.66 0l4.24 4.24"/></svg>',
                'users': '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>',
                'user-check': '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><polyline points="17 11 19 13 23 9"/></svg>',
                'user-plus': '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>',
                'chevron-right': '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>',
                'plus': '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>',
                'edit': '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>',
                'trash-2': '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>',
                'download': '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>',
                'x': '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>',
                'log-out': '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>',
                'dollar-sign': '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>',
                'google': '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"/><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"/><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.222,0-9.641-3.317-11.28-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"/><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571l6.19,5.238C42.022,36.217,44,30.561,44,24C44,22.659,43.862,21.35,43.611,20.083z"/></svg>',
                'menu': '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>',
                'user-cog': '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><circle cx="19" cy="11.5" r="2.5"/><path d="M19 8v1.5"/><path d="M19 13.5V15"/><path d="m21.6 10-1.1 1.1"/><path d="m17.5 12.5-1.1 1.1"/><path d="m21.6 13-1.1-1.1"/><path d="m17.5 10.5-1.1-1.1"/></svg>',
                'filter': '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>'
            };

            return (
                <span
                    className={`icon ${className}`}
                    style={{ width: size, height: size }}
                    dangerouslySetInnerHTML={{ __html: icons[name] || icons['briefcase'] }}
                />
            );
        };

        // 차트 컴포넌트
        const ChartComponent = ({ type, data, options }) => {
            const canvasRef = useRef(null);
            const chartRef = useRef(null);

            useEffect(() => {
                if (canvasRef.current) {
                    if (chartRef.current) {
                        chartRef.current.destroy();
                    }
                    const ctx = canvasRef.current.getContext('2d');
                    chartRef.current = new Chart(ctx, {
                        type: type,
                        data: data,
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            ...options
                        }
                    });
                }
                return () => {
                    if (chartRef.current) {
                        chartRef.current.destroy();
                    }
                };
            }, [type, data, options]);

            return <canvas ref={canvasRef} />;
        };

        // 로그인 컴포넌트 (Google 로그인 버튼)
        const Login = ({ onLogin }) => {
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleGoogleLogin = async () => {
                setError('');
                setLoading(true);
                try {
                    const provider = new firebase.auth.GoogleAuthProvider();
                    await auth.signInWithPopup(provider);
                    onLogin();
                } catch (err) {
                    setError('로그인 실패: ' + err.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
                    <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full text-center">
                        <h1 className="text-3xl font-bold text-gray-800 mb-8">
                            채용 현황 관리 시스템
                        </h1>

                        {error && (
                            <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded mb-6">
                                {error}
                            </div>
                        )}

                        <button
                            onClick={handleGoogleLogin}
                            disabled={loading}
                            className="w-full bg-white border border-gray-300 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-50 transition-all shadow-md disabled:opacity-50 flex items-center justify-center space-x-2"
                        >
                            <Icon name="google" size={20} />
                            <span>
                                {loading ? '로그인 중...' : 'Google 계정으로 로그인'}
                            </span>
                        </button>
                    </div>
                </div>
            );
        };

        // --- 메인 앱 ---
        const App = () => {
            const [user, setUser] = useState(null);
            const [authLoading, setAuthLoading] = useState(true);

            const [currentPage, setCurrentPage] = useState('dashboard');
            const [jobs, setJobs] = useState([]);
            const [dailyRecords, setDailyRecords] = useState([]); // 조회수 기록용
            const [applicants, setApplicants] = useState([]); // 지원자 데이터
            const [siteSettings, setSiteSettings] = useState([]);
            const [goals, setGoals] = useState([]);
            const [loading, setLoading] = useState(true);

            const [isSidebarOpen, setIsSidebarOpen] = useState(false);

            useEffect(() => {
                // --- Firebase 설정 직접 입력 ---
                 const firebaseConfig = {
                  apiKey: "AIzaSyAObneOsBpf4up7PRQLx6KUM_ixvuZqcUQ",
                  authDomain: "recruitment-system-8f83c.firebaseapp.com",
                  projectId: "recruitment-system-8f83c",
                  storageBucket: "recruitment-system-8f83c.firebasestorage.app",
                  messagingSenderId: "627405471475",
                  appId: "1:627405471475:web:8bbbf4d4b6302671190186"
                };

                const success = initFirebase(firebaseConfig);

                if (success) {
                    const unsubscribe = auth.onAuthStateChanged(firebaseUser => {
                        if (firebaseUser) {
                            setUser(firebaseUser);
                            loadData(); // 로그인 시 데이터 로드
                        } else {
                            setUser(null);
                            // 로그아웃 시 데이터 초기화
                            setJobs([]);
                            setDailyRecords([]);
                            setApplicants([]);
                            setSiteSettings([]);
                            setGoals([]);
                        }
                        setAuthLoading(false);
                    });
                    return () => unsubscribe();
                } else {
                    console.error("Firebase 초기화 실패!");
                    alert("Firebase 초기화에 실패했습니다. 코드를 확인해주세요.");
                    setAuthLoading(false);
                    setLoading(false);
                }
            }, []);

            const handleLogin = () => {
                 setAuthLoading(true);
            }

            // 데이터 로드 함수
            const loadData = useCallback(async () => {
                if (!auth.currentUser) return;
                try {
                    setLoading(true);
                    const [jobsSnapshot, recordsSnapshot, applicantsSnapshot, settingsSnapshot, goalsSnapshot] = await Promise.all([
                        db.collection('jobs').get(),
                        db.collection('dailyRecords').get(),
                        db.collection('applicants').orderBy('appliedDate', 'desc').get(),
                        db.collection('siteSettings').get(),
                        db.collection('goals').get()
                    ]);

                    setJobs(jobsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    setDailyRecords(recordsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    setApplicants(applicantsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    setSiteSettings(settingsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    setGoals(goalsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));

                } catch (error) {
                    console.error("데이터 로드 오류:", error);
                    setLoading(false); // 오류 시 로딩 해제
                } finally {
                    setLoading(false); // 성공/실패 무관 로딩 해제
                }
            }, []);


            if (authLoading) {
                 return (
                    <div className="min-h-screen flex items-center justify-center">
                        <div className="text-center">
                            <div className="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-600 mx-auto mb-4"></div>
                            <p className="text-gray-600">인증 확인 중...</p>
                        </div>
                    </div>
                 );
            }

            if (!user) {
                return <Login onLogin={handleLogin} />;
            }

            // 초기 로딩 시 또는 데이터가 없을 때 로딩 표시
            if (loading && !jobs.length && !applicants.length) {
                 return (
                     <div className="min-h-screen flex items-center justify-center">
                        <div className="text-center">
                            <div className="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-600 mx-auto mb-4"></div>
                            <p className="text-gray-600">데이터를 불러오는 중...</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="flex flex-col md:flex-row h-screen bg-gray-50 relative">
                    <Sidebar
                        currentPage={currentPage}
                        setCurrentPage={setCurrentPage}
                        user={user}
                        isSidebarOpen={isSidebarOpen}
                        setIsSidebarOpen={setIsSidebarOpen}
                    />
                    <div className="flex-1 overflow-auto">
                        {/* 모바일 헤더 */}
                        <div className="sticky top-0 bg-white shadow-sm p-4 z-10 md:hidden flex justify-between items-center">
                            <h1 className="text-lg font-bold text-gray-800">
                                { currentPage === 'applicants' ? '지원자 관리' :
                                  currentPage === 'daily' ? '조회수 업데이트' :
                                  currentPage.charAt(0).toUpperCase() + currentPage.slice(1) }
                            </h1>
                            <button onClick={() => setIsSidebarOpen(true)} className="text-gray-600">
                                <Icon name="menu" size={28} />
                            </button>
                        </div>

                        {/* 페이지 렌더링 */}
                        {currentPage === 'dashboard' && <Dashboard jobs={jobs} dailyRecords={dailyRecords} applicants={applicants} siteSettings={siteSettings} goals={goals} />}
                        {currentPage === 'jobs' && <JobManagement jobs={jobs} applicants={applicants} loadData={loadData} />}
                        {currentPage === 'applicants' && <ApplicantManagement applicants={applicants} jobs={jobs} loadData={loadData} />}
                        {currentPage === 'daily' && <DailyUpdate jobs={jobs} dailyRecords={dailyRecords} loadData={loadData} />}
                        {currentPage === 'compare' && <SiteComparison jobs={jobs} applicants={applicants} dailyRecords={dailyRecords} />} {/* dailyRecords 추가 */}
                        {currentPage === 'efficiency' && <EfficiencyAnalysis jobs={jobs} applicants={applicants} siteSettings={siteSettings} />}
                        {currentPage === 'trends' && <TrendAnalysis jobs={jobs} dailyRecords={dailyRecords} applicants={applicants} />}
                        {currentPage === 'settings' && <Settings siteSettings={siteSettings} goals={goals} loadData={loadData} />}
                    </div>
                </div>
            );
        };

        // --- 사이드바 ---
        const Sidebar = ({ currentPage, setCurrentPage, user, isSidebarOpen, setIsSidebarOpen }) => {
            const menuItems = [
                { id: 'dashboard', name: '대시보드', icon: 'layout-dashboard' },
                { id: 'jobs', name: '공고 관리', icon: 'briefcase' },
                { id: 'applicants', name: '지원자 관리', icon: 'user-cog' },
                { id: 'daily', name: '조회수 업데이트', icon: 'plus-circle' },
                { id: 'compare', name: '사이트 비교', icon: 'git-compare' },
                { id: 'efficiency', name: '효율성 분석', icon: 'trending-up' },
                { id: 'trends', name: '트렌드 분석', icon: 'line-chart' },
                { id: 'settings', name: '설정', icon: 'settings' }
            ];

            const handleLogout = () => {
                if (confirm('로그아웃 하시겠습니까?')) {
                    auth.signOut();
                }
            };

            const selectMenu = (id) => {
                setCurrentPage(id);
                setIsSidebarOpen(false);
            };

            return (
                <>
                    {isSidebarOpen && (
                        <div
                            className="fixed inset-0 bg-black bg-opacity-50 z-20 md:hidden"
                            onClick={() => setIsSidebarOpen(false)}
                        ></div>
                    )}
                    <div
                        className={`sidebar w-64 bg-gradient-to-b from-gray-900 to-gray-800 text-white p-4 shadow-2xl flex flex-col h-full
                                    fixed inset-y-0 left-0 z-30 transform md:relative md:translate-x-0
                                    ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'}`}
                    >
                        <div className="mb-8 text-center">
                            <h1 className="text-xl font-bold">채용 현황 관리</h1>
                            <p className="text-xs text-gray-400 mt-1">Recruitment Dashboard</p>
                        </div>
                        <nav className="space-y-2 flex-1 overflow-y-auto">
                            {menuItems.map(item => (
                                <button
                                    key={item.id}
                                    onClick={() => selectMenu(item.id)}
                                    className={`w-full flex items-center space-x-3 px-4 py-3 rounded-lg transition-all ${
                                        currentPage === item.id
                                            ? 'bg-blue-600 shadow-lg'
                                            : 'hover:bg-gray-700'
                                    }`}
                                >
                                    <Icon name={item.icon} size={20} />
                                    <span>{item.name}</span>
                                </button>
                            ))}
                        </nav>

                        <div className="mt-auto border-t border-gray-700 pt-4">
                           <div className="flex items-center space-x-3 mb-2 px-2">
                                {user.photoURL ? (
                                    <img src={user.photoURL} alt="Profile" className="w-8 h-8 rounded-full" />
                                ) : (
                                    <div className="w-8 h-8 rounded-full bg-gray-600 flex items-center justify-center text-sm font-bold">
                                        {user.displayName ? user.displayName[0] : user.email[0]}
                                    </div>
                                )}
                                <span className="text-sm text-gray-300 truncate" title={user.displayName || user.email}>
                                    {user.displayName || user.email}
                                </span>
                            </div>
                             <button
                                onClick={handleLogout}
                                className="w-full flex items-center space-x-3 px-4 py-3 rounded-lg transition-all hover:bg-red-600"
                            >
                                <Icon name="log-out" size={20} />
                                <span>로그아웃</span>
                            </button>
                        </div>
                    </div>
                </>
            );
        };

        // --- 대시보드 위젯 설정 모달 ---
        const DashboardSettingsModal = ({ settings, onSave, onClose }) => {
            const [currentSettings, setCurrentSettings] = useState(settings);

            const handleToggle = (key) => {
                setCurrentSettings(prev => ({ ...prev, [key]: !prev[key] }));
            };

            const handleSave = () => {
                onSave(currentSettings);
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 transition-all modal-enter-active">
                    <div className="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="text-xl font-bold text-gray-800">대시보드 위젯 설정</h3>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-600">
                                <Icon name="x" size={20} />
                            </button>
                        </div>

                        <div className="space-y-4">
                            <label className="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                <span className="font-medium text-gray-700">KPI 카드</span>
                                <input
                                    type="checkbox"
                                    checked={currentSettings.kpi}
                                    onChange={() => handleToggle('kpi')}
                                    className="h-5 w-5 text-blue-600 rounded"
                                />
                            </label>
                            <label className="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                <span className="font-medium text-gray-700">전환율 분석</span>
                                <input
                                    type="checkbox"
                                    checked={currentSettings.conversion}
                                    onChange={() => handleToggle('conversion')}
                                    className="h-5 w-5 text-blue-600 rounded"
                                />
                            </label>
                            <label className="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                <span className="font-medium text-gray-700">사이트별 현황</span>
                                <input
                                    type="checkbox"
                                    checked={currentSettings.siteSummary}
                                    onChange={() => handleToggle('siteSummary')}
                                    className="h-5 w-5 text-blue-600 rounded"
                                />
                            </label>
                        </div>

                        <div className="mt-6">
                            <button
                                onClick={handleSave}
                                className="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors"
                            >
                                저장
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- 대시보드 ---
        const Dashboard = ({ jobs, dailyRecords, applicants, siteSettings, goals }) => {
            const [dateRangeType, setDateRangeType] = useState('all');
            const [customRange, setCustomRange] = useState({ start: '', end: '' });
            const [siteFilter, setSiteFilter] = useState('all');
            const [showSettingsModal, setShowSettingsModal] = useState(false);
            const [widgetSettings, setWidgetSettings] = useState(() => {
                const saved = localStorage.getItem('dashboardWidgetSettings');
                return saved ? JSON.parse(saved) : { kpi: true, conversion: true, siteSummary: true };
            });

            const handleSaveWidgetSettings = (newSettings) => {
                setWidgetSettings(newSettings);
                localStorage.setItem('dashboardWidgetSettings', JSON.stringify(newSettings));
                setShowSettingsModal(false);
            };

            const dateRange = useMemo(() => {
                const today = new Date();
                const todayStr = today.toISOString().split('T')[0];
                if (dateRangeType === 'week') {
                    const weekAgo = new Date(new Date().setDate(today.getDate() - 7));
                    return { start: weekAgo.toISOString().split('T')[0], end: todayStr };
                }
                if (dateRangeType === 'month') {
                    const monthAgo = new Date(new Date().setMonth(today.getMonth() - 1));
                    return { start: monthAgo.toISOString().split('T')[0], end: todayStr };
                }
                if (dateRangeType === 'custom' && customRange.start && customRange.end) {
                    return customRange;
                }
                return { start: null, end: todayStr };
            }, [dateRangeType, customRange]);

            const filteredData = useMemo(() => {
                const filteredJobs = siteFilter === 'all' ? jobs : jobs.filter(j => j.site === siteFilter);
                const jobIds = filteredJobs.map(j => j.id);

                const filteredRecords = dailyRecords.filter(r => {
                    const inSite = jobIds.includes(r.jobId);
                    if (!inSite) return false;
                    if (dateRange.start && dateRange.end && dateRangeType !== 'all') {
                        return r.date >= dateRange.start && r.date <= dateRange.end;
                    }
                    return true;
                });

                const filteredApplicants = applicants.filter(a => {
                    const inSite = jobIds.includes(a.appliedJobId);
                    if (!inSite) return false;
                    if (dateRange.start && dateRange.end && dateRangeType !== 'all') {
                        // 지원일 기준 필터링
                        return a.appliedDate >= dateRange.start && a.appliedDate <= dateRange.end;
                    }
                    return true;
                });

                return { filteredJobs, filteredRecords, filteredApplicants };
            }, [jobs, dailyRecords, applicants, siteFilter, dateRange, dateRangeType]);

            const stats = useMemo(() => {
                const activeJobs = filteredData.filteredJobs.filter(j => j.status === '진행중');
                const totalViews = filteredData.filteredRecords.reduce((sum, r) => sum + (r.viewsIncrease || 0), 0);
                const totals = { applications: 0, interviews: 0, offers: 0, hires: 0 };
                filteredData.filteredApplicants.forEach(a => {
                    totals.applications++;
                    if (['면접', '합격', '입사'].includes(a.status)) totals.interviews++; // 면접 이후 단계는 면접 집계에 포함 (정의에 따라 변경 가능)
                    if (['합격', '입사'].includes(a.status)) totals.offers++;
                    if (a.status === '입사') totals.hires++;
                });

                const conversionRate = totals.applications > 0 ? ((totals.hires / totals.applications) * 100).toFixed(1) : 0;

                const targetYearMonth = dateRange.end.substring(0, 7);
                const currentGoal = goals.find(g => g.yearMonth === targetYearMonth);
                let targetHires = 0;
                if (currentGoal) {
                    if (siteFilter === 'all') targetHires = currentGoal.targetHires || 0;
                    else if (siteFilter === '사람인') targetHires = currentGoal.targetSaramin || 0;
                    else if (siteFilter === '잡코리아') targetHires = currentGoal.targetJobkorea || 0;
                    else if (siteFilter === '인크루트') targetHires = currentGoal.targetIncruit || 0;
                }
                const achievementRate = targetHires > 0 ? ((totals.hires / targetHires) * 100).toFixed(0) : 0;

                let totalCost = 0;
                const filteredSettings = siteFilter === 'all' ? siteSettings : siteSettings.filter(s => s.site === siteFilter);
                filteredSettings.forEach(s => { totalCost += s.monthlyCost || 0; });
                const costPerHire = totals.hires > 0 ? (totalCost / totals.hires).toLocaleString(undefined, { maximumFractionDigits: 0 }) : 0;

                return {
                    activeJobs: activeJobs.length,
                    views: totalViews,
                    ...totals,
                    conversionRate,
                    targetHires,
                    achievementRate,
                    costPerHire
                };
            }, [filteredData, siteFilter, dateRange, goals, siteSettings]);

            return (
                <div className="p-4 md:p-8">
                    {showSettingsModal && (
                        <DashboardSettingsModal settings={widgetSettings} onSave={handleSaveWidgetSettings} onClose={() => setShowSettingsModal(false)} />
                    )}

                    <div className="hidden md:flex justify-between items-start mb-8">
                        <div>
                            <h2 className="text-3xl font-bold text-gray-800">대시보드</h2>
                            <p className="text-gray-600">
                                {siteFilter === 'all' ? '전체 사이트' : siteFilter}
                                {dateRangeType !== 'all' ? ` | ${dateRange.start} ~ ${dateRange.end}` : ' | 전체 기간'}
                            </p>
                        </div>
                        <button onClick={() => setShowSettingsModal(true)} className="text-gray-500 hover:text-gray-800 p-2 rounded-full hover:bg-gray-100">
                            <Icon name="settings" size={24} />
                        </button>
                    </div>

                    <div className="bg-white rounded-xl shadow-lg p-4 mb-8">
                        <div className="flex flex-wrap items-center gap-4">
                            <div className="flex space-x-1 bg-gray-100 p-1 rounded-lg">
                                {['all', 'week', 'month', 'custom'].map(type => (
                                    <button key={type} onClick={() => setDateRangeType(type)} className={`px-3 py-1 rounded-md text-sm font-medium ${dateRangeType === type ? 'bg-white shadow text-blue-600' : 'text-gray-600 hover:text-gray-800'}`}>
                                        { {all: '전체', week: '1주', month: '1개월', custom: '기간'}[type] }
                                    </button>
                                ))}
                            </div>
                            {dateRangeType === 'custom' && (
                                <div className="flex items-center space-x-2">
                                    <input type="date" value={customRange.start} onChange={(e) => setCustomRange(p => ({...p, start: e.target.value}))} className="input-style px-3 py-1 text-sm" />
                                    <span>~</span>
                                    <input type="date" value={customRange.end} onChange={(e) => setCustomRange(p => ({...p, end: e.target.value}))} className="input-style px-3 py-1 text-sm" />
                                </div>
                            )}
                            <div>
                                <select value={siteFilter} onChange={(e) => setSiteFilter(e.target.value)} className="input-style px-3 py-2 text-sm font-medium bg-white">
                                    <option value="all">전체 사이트</option>
                                    <option value="사람인">사람인</option>
                                    <option value="잡코리아">잡코리아</option>
                                    <option value="인크루트">인크루트</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    {widgetSettings.kpi && (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                            <KPICard title="진행중인 공고" value={stats.activeJobs} icon="briefcase" color="blue" />
                            <KPICard title="총 지원자" value={stats.applications} icon="users" color="green" />
                            <KPICard title="1인당 채용 비용 (월 기준)" value={stats.costPerHire > 0 ? `${stats.costPerHire}원` : '-'} icon="dollar-sign" color="purple" />
                            <KPICard title="입사자" value={`${stats.hires} / ${stats.targetHires}`} icon="user-plus" color="orange" subText={stats.targetHires > 0 ? `달성률 ${stats.achievementRate}%` : '목표 미설정'}/>
                        </div>
                    )}

                    {widgetSettings.conversion && (
                        <div className="bg-white rounded-xl shadow-lg p-6 mb-8">
                            <h3 className="text-xl font-semibold mb-4">전환율 분석</h3>
                            <div className="flex items-center justify-around flex-wrap gap-4">
                                <ConversionStep label="조회" value={stats.views} />
                                <Icon name="chevron-right" className="text-gray-400" />
                                <ConversionStep label="지원" value={stats.applications} />
                                <Icon name="chevron-right" className="text-gray-400" />
                                <ConversionStep label="면접" value={stats.interviews} />
                                <Icon name="chevron-right" className="text-gray-400" />
                                <ConversionStep label="합격" value={stats.offers} />
                                <Icon name="chevron-right" className="text-gray-400" />
                                <ConversionStep label="입사" value={stats.hires} />
                            </div>
                            <div className="mt-6 text-center">
                                <p className="text-gray-600">총 전환율 (지원자 → 입사자)</p>
                                <p className="text-4xl font-bold text-blue-600">{stats.conversionRate}%</p>
                            </div>
                        </div>
                    )}

                    {widgetSettings.siteSummary && (
                        <div className="bg-white rounded-xl shadow-lg p-6">
                            <h3 className="text-xl font-semibold mb-4">사이트별 현황</h3>
                            <SiteSummary jobs={jobs} dailyRecords={dailyRecords} applicants={applicants} filter={siteFilter === 'all' ? null : siteFilter} />
                        </div>
                    )}
                </div>
            );
        };

        // KPI 카드
        const KPICard = ({ title, value, icon, color, subText }) => {
            const colorClasses = {
                blue: 'from-blue-500 to-blue-600',
                green: 'from-green-500 to-green-600',
                purple: 'from-purple-500 to-purple-600',
                orange: 'from-orange-500 to-orange-600'
            };
            return (
                <div className={`bg-gradient-to-br ${colorClasses[color]} rounded-xl shadow-lg p-6 text-white`}>
                    <div className="flex items-center justify-between mb-2">
                        <Icon name={icon} size={32} />
                        <span className="text-3xl font-bold">{value}</span>
                    </div>
                    <p className="text-sm opacity-90">{title}</p>
                    {subText && <p className="text-sm font-bold text-right mt-1">{subText}</p>}
                </div>
            );
        };

        // 전환율 단계
        const ConversionStep = ({ label, value }) => (
            <div className="text-center">
                <div className="text-2xl font-bold text-gray-800">{value}</div>
                <div className="text-sm text-gray-600">{label}</div>
            </div>
        );

        // --- 사이트별 현황 ---
        const SiteSummary = ({ jobs, dailyRecords, applicants, filter }) => {
            const allSites = ['사람인', '잡코리아', '인크루트'];
            const sites = filter ? [filter] : allSites;

            const siteData = sites.map(site => {
                const siteJobs = jobs.filter(j => j.site === site);
                const jobIds = siteJobs.map(j => j.id);

                const siteRecords = dailyRecords.filter(r => jobIds.includes(r.jobId));
                const totalViews = siteRecords.reduce((sum, r) => sum + (r.viewsIncrease || 0), 0);

                const siteApplicants = applicants.filter(a => jobIds.includes(a.appliedJobId));
                const totals = { jobs: siteJobs.length, views: totalViews, applications: 0, contacts: 0, interviews: 0, offers: 0, hires: 0 };
                siteApplicants.forEach(a => {
                    totals.applications++;
                    // contacts 필요 시 반영
                    if (['면접', '합격', '입사'].includes(a.status)) totals.interviews++;
                    if (['합격', '입사'].includes(a.status)) totals.offers++;
                    if (a.status === '입사') totals.hires++;
                });
                return { site, ...totals };
            });

            return (
                <div className={`grid grid-cols-1 ${filter ? '' : 'md:grid-cols-3'} gap-4`}>
                    {siteData.map(data => (
                        <div key={data.site} className="border border-gray-200 rounded-lg p-4">
                            <h4 className="font-semibold text-lg mb-3">{data.site}</h4>
                            <div className="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
                                <div className="flex justify-between"><span className="text-gray-600">공고 수:</span><span className="font-semibold">{data.jobs}</span></div>
                                <div className="flex justify-between"><span className="text-gray-600">조회수:</span><span className="font-semibold">{data.views}</span></div>
                                <div className="flex justify-between"><span className="text-gray-600">지원자:</span><span className="font-semibold">{data.applications}</span></div>
                                <div className="flex justify-between"><span className="text-gray-600">컨택:</span><span className="font-semibold">{data.contacts}</span></div>
                                <div className="flex justify-between"><span className="text-gray-600">면접:</span><span className="font-semibold">{data.interviews}</span></div>
                                <div className="flex justify-between"><span className="text-gray-600">합격:</span><span className="font-semibold">{data.offers}</span></div>
                                <div className="flex justify-between col-span-2 border-t pt-2 mt-1"><span className="text-gray-600 font-bold">입과:</span><span className="font-bold text-lg text-blue-600">{data.hires}명</span></div>
                            </div>
                        </div>
                    ))}
                </div>
            );
        };

        // --- 공고별 상세 분석 모달 ---
        const JobDetailModal = ({ job, applicants, onClose }) => {
            const jobStats = useMemo(() => {
                const jobApplicants = applicants.filter(a => a.appliedJobId === job.id);
                const totals = { applications: 0, contacts: 0, interviews: 0, offers: 0, hires: 0 };
                const trend = {};

                jobApplicants.forEach(a => {
                    totals.applications++;
                    // contacts 필요 시 반영
                    if (['면접', '합격', '입사'].includes(a.status)) totals.interviews++;
                    if (['합격', '입사'].includes(a.status)) totals.offers++;
                    if (a.status === '입사') totals.hires++;
                    trend[a.appliedDate] = (trend[a.appliedDate] || 0) + 1;
                });

                const conversionRate = totals.applications > 0 ? ((totals.hires / totals.applications) * 100).toFixed(1) : 0;
                const sortedTrend = Object.entries(trend).sort((a, b) => a[0].localeCompare(b[0]));

                return { ...totals, conversionRate, trendData: sortedTrend, applicantList: jobApplicants };
            }, [job, applicants]);

            const chartData = {
                labels: jobStats.trendData.map(d => d[0]),
                datasets: [{
                    label: '일별 지원자 수',
                    data: jobStats.trendData.map(d => d[1]),
                    borderColor: 'rgb(59, 130, 246)',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.1,
                    fill: true
                }]
            };

            return (
                 <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 modal-enter-active">
                    <div className="bg-white rounded-xl shadow-2xl p-6 md:p-8 max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                        <div className="flex justify-between items-center mb-6">
                            <div>
                                <h3 className="text-2xl font-bold text-gray-800">{job.title}</h3>
                                <p className="text-gray-600">{job.site} | {job.position}</p>
                            </div>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-600"> <Icon name="x" size={24} /> </button>
                        </div>

                        <div className="grid grid-cols-2 md:grid-cols-3 gap-4 mb-6">
                             <div className="bg-gray-50 p-4 rounded-lg text-center">
                                <p className="text-sm text-gray-600">총 지원자</p>
                                <p className="text-3xl font-bold text-blue-600">{jobStats.applications}</p>
                            </div>
                             <div className="bg-gray-50 p-4 rounded-lg text-center">
                                <p className="text-sm text-gray-600">총 입사자</p>
                                <p className="text-3xl font-bold text-green-600">{jobStats.hires}</p>
                            </div>
                             <div className="bg-gray-50 p-4 rounded-lg text-center">
                                <p className="text-sm text-gray-600">전환율</p>
                                <p className="text-3xl font-bold text-purple-600">{jobStats.conversionRate}%</p>
                            </div>
                        </div>

                        <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
                            <h4 className="text-xl font-semibold mb-4">단계별 상세</h4>
                            <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                                <ConversionStep label="컨택" value={jobStats.contacts} />
                                <ConversionStep label="면접" value={jobStats.interviews} />
                                <ConversionStep label="합격" value={jobStats.offers} />
                            </div>
                        </div>

                        <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
                             <h4 className="text-xl font-semibold mb-4">일별 지원자 트렌드</h4>
                             <div style={{ height: '250px' }}>
                                <ChartComponent type="line" data={chartData} options={{ scales: { y: { beginAtZero: true } } }} />
                            </div>
                        </div>

                        <div className="bg-white rounded-xl shadow-lg p-6">
                            <h4 className="text-xl font-semibold mb-4">지원자 목록 ({jobStats.applicantList.length}명)</h4>
                            <div className="overflow-x-auto">
                                <table className="w-full text-sm">
                                    <thead className="bg-gray-50">
                                        <tr>
                                            <th className="px-4 py-2 text-left font-medium text-gray-500">이름</th>
                                            <th className="px-4 py-2 text-left font-medium text-gray-500">성별</th>
                                            <th className="px-4 py-2 text-left font-medium text-gray-500">연령대</th>
                                            <th className="px-4 py-2 text-left font-medium text-gray-500">연락처</th>
                                            <th className="px-4 py-2 text-left font-medium text-gray-500">지원일</th>
                                            <th className="px-4 py-2 text-left font-medium text-gray-500">상태</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-gray-200">
                                        {jobStats.applicantList.map(a => (
                                            <tr key={a.id}>
                                                <td className="px-4 py-2 table-cell-nowrap">{a.name}</td>
                                                <td className="px-4 py-2 table-cell-nowrap">{a.gender}</td>
                                                <td className="px-4 py-2 table-cell-nowrap">{a.ageGroup}</td>
                                                <td className="px-4 py-2 table-cell-nowrap">{a.contactInfo}</td>
                                                <td className="px-4 py-2 table-cell-nowrap">{a.appliedDate}</td>
                                                <td className="px-4 py-2 table-cell-nowrap"> <ApplicantStatusBadge status={a.status} /> </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                                {jobStats.applicantList.length === 0 && <p className="text-center text-gray-500 py-4">이 공고의 지원자가 없습니다.</p>}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };


        // --- 공고 관리 ---
        const JobManagement = ({ jobs, applicants, loadData }) => {
            const [showForm, setShowForm] = useState(false);
            const [editingJob, setEditingJob] = useState(null);
            const [selectedJob, setSelectedJob] = useState(null);
            const [formData, setFormData] = useState({ site: '사람인', title: '', position: '', company: '', startDate: '', endDate: '', status: '진행중', memo: '' });

            const handleSubmit = async (e) => {
                e.preventDefault();
                try {
                    const data = { ...formData, updatedAt: new Date().toISOString() };
                    if (editingJob) {
                        await db.collection('jobs').doc(editingJob.id).update(data);
                    } else {
                        await db.collection('jobs').add({ ...data, createdAt: new Date().toISOString() });
                    }
                    resetForm();
                    loadData();
                    alert('저장되었습니다!');
                } catch (error) { alert('저장 실패: ' + error.message); }
            };

            const handleEdit = (e, job) => {
                e.stopPropagation();
                setEditingJob(job);
                setFormData(job);
                setShowForm(true);
            };

            const handleDelete = async (e, id) => {
                e.stopPropagation();
                if (confirm('정말 삭제하시겠습니까?')) {
                    try {
                        // TODO: 연관된 지원자 처리 정책 필요 (예: 삭제하거나, 연결 해제)
                        await db.collection('jobs').doc(id).delete();
                        loadData();
                        alert('삭제되었습니다!');
                    } catch (error) { alert('삭제 실패: ' + error.message); }
                }
            };
            
            const resetForm = () => {
                setShowForm(false);
                setEditingJob(null);
                setFormData({ site: '사람인', title: '', position: '', company: '', startDate: '', endDate: '', status: '진행중', memo: '' });
            };

            return (
                <div className="p-4 md:p-8">
                    <div className="flex justify-between items-center mb-8">
                        <h2 className="text-2xl md:text-3xl font-bold text-gray-800">공고 관리</h2>
                        <button onClick={() => setShowForm(true)} className="btn-primary px-4 py-2 md:px-6 md:py-3 flex items-center space-x-2">
                            <Icon name="plus" size={20} /> <span className="hidden md:inline">공고 추가</span>
                        </button>
                    </div>

                    {showForm && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-xl shadow-2xl p-6 md:p-8 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                                <h3 className="text-2xl font-bold mb-6">{editingJob ? '공고 수정' : '공고 추가'}</h3>
                                <form onSubmit={handleSubmit} className="space-y-4">
                                     <div>
                                        <label className="label-style">채용 사이트</label>
                                        <Select name="site" value={formData.site} onChange={e => setFormData({...formData, site: e.target.value})} required>
                                            <option>사람인</option> <option>잡코리아</option> <option>인크루트</option>
                                        </Select>
                                    </div>
                                    <div><label className="label-style">공고 제목</label><Input type="text" name="title" value={formData.title} onChange={e => setFormData({...formData, title: e.target.value})} required /></div>
                                    <div><label className="label-style">직무/포지션</label><Input type="text" name="position" value={formData.position} onChange={e => setFormData({...formData, position: e.target.value})} required /></div>
                                    <div><label className="label-style">게시 업체명</label><Input type="text" name="company" value={formData.company} onChange={e => setFormData({...formData, company: e.target.value})} required /></div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div><label className="label-style">게시 시작일</label><Input type="date" name="startDate" value={formData.startDate} onChange={e => setFormData({...formData, startDate: e.target.value})} required /></div>
                                        <div><label className="label-style">게시 종료일</label><Input type="date" name="endDate" value={formData.endDate} onChange={e => setFormData({...formData, endDate: e.target.value})} required /></div>
                                    </div>
                                    <div>
                                        <label className="label-style">공고 상태</label>
                                        <Select name="status" value={formData.status} onChange={e => setFormData({...formData, status: e.target.value})}>
                                            <option>진행중</option> <option>마감</option>
                                        </Select>
                                    </div>
                                    <div><label className="label-style">메모</label><Textarea name="memo" value={formData.memo} onChange={e => setFormData({...formData, memo: e.target.value})} rows="3" /></div>
                                    <div className="flex space-x-4">
                                        <Button type="submit" variant="primary" className="flex-1">{editingJob ? '수정' : '추가'}</Button>
                                        <Button type="button" variant="secondary" className="flex-1" onClick={resetForm}>취소</Button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {selectedJob && <JobDetailModal job={selectedJob} applicants={applicants} onClose={() => setSelectedJob(null)} />}

                    <div className="bg-white rounded-xl shadow-lg overflow-hidden">
                        <div className="overflow-x-auto">
                            <table className="w-full">
                                <thead className="bg-gray-50">
                                    <tr>
                                        <th className="th-style">사이트</th>
                                        <th className="th-style">공고 제목</th>
                                        <th className="th-style">직무</th>
                                        <th className="th-style">업체명</th>
                                        <th className="th-style">기간</th>
                                        <th className="th-style">상태</th>
                                        <th className="th-style">작업</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-200">
                                    {jobs.map(job => (
                                        <tr key={job.id} className="hover:bg-gray-100 cursor-pointer" onClick={() => setSelectedJob(job)}>
                                            <td className="td-style table-cell-nowrap"><span className="badge-blue">{job.site}</span></td>
                                            <td className="td-style table-cell-nowrap">{job.title}</td>
                                            <td className="td-style table-cell-nowrap">{job.position}</td>
                                            <td className="td-style table-cell-nowrap">{job.company}</td>
                                            <td className="td-style table-cell-nowrap text-sm text-gray-600">{job.startDate} ~ {job.endDate}</td>
                                            <td className="td-style table-cell-nowrap"><span className={job.status === '진행중' ? 'badge-green' : 'badge-gray'}>{job.status}</span></td>
                                            <td className="td-style table-cell-nowrap">
                                                <div className="flex space-x-2">
                                                    <button onClick={(e) => handleEdit(e, job)} className="text-blue-600 hover:text-blue-800"><Icon name="edit" size={18} /></button>
                                                    <button onClick={(e) => handleDelete(e, job.id)} className="text-red-600 hover:text-red-800"><Icon name="trash-2" size={18} /></button>
                                                </div>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                        {jobs.length === 0 && <div className="text-center py-12 text-gray-500">등록된 공고가 없습니다.</div>}
                    </div>
                </div>
            );
        };

        // --- 지원자 상태 뱃지 ---
        const ApplicantStatusBadge = ({ status }) => {
            const colors = {
                '지원': 'bg-blue-100 text-blue-800', '서류검토': 'bg-yellow-100 text-yellow-800',
                '면접': 'bg-purple-100 text-purple-800', '합격': 'bg-green-100 text-green-800',
                '입사': 'bg-emerald-100 text-emerald-800', '불합격': 'bg-red-100 text-red-800',
            };
            return (
                <span className={`px-2 py-1 text-xs font-semibold rounded-full ${colors[status] || 'bg-gray-100 text-gray-800'}`}>
                    {status || '미지정'}
                </span>
            );
        };

        // --- 지원자 관리 ---
        const ApplicantManagement = ({ applicants, jobs, loadData }) => {
            const [showForm, setShowForm] = useState(false);
            const [editingApplicant, setEditingApplicant] = useState(null);
            const [formData, setFormData] = useState({ name: '', gender: '남', ageGroup: '20대', contactInfo: '', appliedJobId: '', appliedDate: new Date().toISOString().split('T')[0], status: '지원', memo: '' });
            const [filters, setFilters] = useState({ jobId: 'all', status: 'all' });
            const [searchTerm, setSearchTerm] = useState('');

            const activeJobs = useMemo(() => jobs.filter(j => j.status === '진행중'), [jobs]);
            const applicantStatuses = ['지원', '서류검토', '면접', '합격', '입사', '불합격'];

            useEffect(() => {
                if (!editingApplicant && activeJobs.length > 0 && !formData.appliedJobId) {
                    setFormData(prev => ({ ...prev, appliedJobId: activeJobs[0].id }));
                }
            }, [activeJobs, editingApplicant, formData.appliedJobId]);

            const handleInputChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!formData.appliedJobId) { alert('지원 공고를 선택해주세요.'); return; }
                try {
                    const data = { ...formData, updatedAt: new Date().toISOString() };
                    if (editingApplicant) {
                        await db.collection('applicants').doc(editingApplicant.id).update(data);
                    } else {
                        await db.collection('applicants').add({ ...data, createdAt: new Date().toISOString() });
                    }
                    resetForm();
                    loadData();
                    alert('저장되었습니다!');
                } catch (error) { alert('저장 실패: ' + error.message); }
            };

            const handleEdit = (applicant) => {
                setEditingApplicant(applicant);
                setFormData({
                    name: applicant.name || '', gender: applicant.gender || '남', ageGroup: applicant.ageGroup || '20대',
                    contactInfo: applicant.contactInfo || '', appliedJobId: applicant.appliedJobId || '',
                    appliedDate: applicant.appliedDate || new Date().toISOString().split('T')[0],
                    status: applicant.status || '지원', memo: applicant.memo || ''
                });
                setShowForm(true);
            };

            const handleDelete = async (id) => {
                if (confirm('정말 삭제하시겠습니까? 지원자 정보가 영구적으로 삭제됩니다.')) {
                    try {
                        await db.collection('applicants').doc(id).delete();
                        loadData();
                        alert('삭제되었습니다!');
                    } catch (error) { alert('삭제 실패: ' + error.message); }
                }
            };

            const resetForm = () => {
                setShowForm(false);
                setEditingApplicant(null);
                setFormData({ name: '', gender: '남', ageGroup: '20대', contactInfo: '', appliedJobId: activeJobs.length > 0 ? activeJobs[0].id : '', appliedDate: new Date().toISOString().split('T')[0], status: '지원', memo: '' });
            };

            const handleStatusChange = async (applicantId, newStatus) => {
                try {
                    await db.collection('applicants').doc(applicantId).update({ status: newStatus, updatedAt: new Date().toISOString() });
                    loadData();
                } catch (error) { alert('상태 변경 실패: ' + error.message); }
            };

            const filteredApplicants = useMemo(() => {
                return applicants.filter(a => {
                    const jobMatch = filters.jobId === 'all' || a.appliedJobId === filters.jobId;
                    const statusMatch = filters.status === 'all' || a.status === filters.status;
                    const nameMatch = searchTerm === '' || (a.name && a.name.toLowerCase().includes(searchTerm.toLowerCase()));
                    return jobMatch && statusMatch && nameMatch;
                });
            }, [applicants, filters, searchTerm]);

            const getJobTitle = useCallback((jobId) => jobs.find(j => j.id === jobId)?.title || 'N/A', [jobs]);

            return (
                <div className="p-4 md:p-8">
                    <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-8">
                        <h2 className="text-2xl md:text-3xl font-bold text-gray-800">지원자 관리</h2>
                        <button onClick={() => setShowForm(true)} className="btn-primary px-4 py-2 md:px-6 md:py-3 flex items-center space-x-2 mt-4 md:mt-0">
                            <Icon name="user-plus" size={20} /> <span>지원자 추가</span>
                        </button>
                    </div>

                    {showForm && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-xl shadow-2xl p-6 md:p-8 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                                <h3 className="text-2xl font-bold mb-6">{editingApplicant ? '지원자 수정' : '지원자 추가'}</h3>
                                <form onSubmit={handleSubmit} className="space-y-4">
                                     <div><label className="label-style">이름</label><Input type="text" name="name" value={formData.name} onChange={handleInputChange} required /></div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div><label className="label-style">성별</label><Select name="gender" value={formData.gender} onChange={handleInputChange}><option>남</option><option>여</option></Select></div>
                                        <div><label className="label-style">연령대</label><Select name="ageGroup" value={formData.ageGroup} onChange={handleInputChange}><option>20대</option><option>30대</option><option>40대</option><option>50대 이상</option></Select></div>
                                    </div>
                                    <div><label className="label-style">연락처</label><Input type="text" name="contactInfo" value={formData.contactInfo} onChange={handleInputChange} /></div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="label-style">지원 공고</label>
                                            <Select name="appliedJobId" value={formData.appliedJobId} onChange={handleInputChange} required>
                                                <option value="">-- 공고 선택 --</option>
                                                {activeJobs.map(job => <option key={job.id} value={job.id}>{job.title} ({job.site})</option>)}
                                            </Select>
                                        </div>
                                        <div><label className="label-style">지원 날짜</label><Input type="date" name="appliedDate" value={formData.appliedDate} onChange={handleInputChange} required /></div>
                                    </div>
                                     <div>
                                        <label className="label-style">현재 상태</label>
                                        <Select name="status" value={formData.status} onChange={handleInputChange}>
                                            {applicantStatuses.map(status => <option key={status} value={status}>{status}</option>)}
                                        </Select>
                                    </div>
                                    <div><label className="label-style">메모</label><Textarea name="memo" value={formData.memo} onChange={handleInputChange} rows="3" /></div>
                                    <div className="flex space-x-4">
                                        <Button type="submit" variant="primary" className="flex-1">{editingApplicant ? '수정' : '추가'}</Button>
                                        <Button type="button" variant="secondary" className="flex-1" onClick={resetForm}>취소</Button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    <div className="bg-white rounded-xl shadow-lg p-4 mb-6">
                        <div className="flex flex-col md:flex-row md:items-center gap-4">
                            <div className="flex-1 min-w-0">
                                <Input type="text" placeholder="이름 검색..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} />
                            </div>
                            <div className="flex space-x-2 w-full md:w-auto">
                                <Select value={filters.jobId} onChange={(e) => setFilters(prev => ({ ...prev, jobId: e.target.value }))} className="filter-select flex-1 md:flex-none">
                                    <option value="all">모든 공고</option>
                                    {activeJobs.map(job => <option key={job.id} value={job.id}>{job.title}</option>)}
                                </Select>
                                <Select value={filters.status} onChange={(e) => setFilters(prev => ({ ...prev, status: e.target.value }))} className="filter-select flex-1 md:flex-none">
                                    <option value="all">모든 상태</option>
                                    {applicantStatuses.map(status => <option key={status} value={status}>{status}</option>)}
                                </Select>
                            </div>
                        </div>
                    </div>

                    <div className="bg-white rounded-xl shadow-lg overflow-hidden">
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm">
                                <thead className="bg-gray-50">
                                    <tr>
                                        <th className="th-style">이름</th>
                                        <th className="th-style">성별</th>
                                        <th className="th-style">연령대</th>
                                        <th className="th-style">연락처</th>
                                        <th className="th-style">지원 공고</th>
                                        <th className="th-style">지원일</th>
                                        <th className="th-style">상태</th>
                                        <th className="th-style">작업</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-200">
                                    {filteredApplicants.map(applicant => (
                                        <tr key={applicant.id} className="hover:bg-gray-50">
                                            <td className="td-style table-cell-nowrap">{applicant.name}</td>
                                            <td className="td-style table-cell-nowrap">{applicant.gender}</td>
                                            <td className="td-style table-cell-nowrap">{applicant.ageGroup}</td>
                                            <td className="td-style table-cell-nowrap">{applicant.contactInfo}</td>
                                            <td className="td-style table-cell-nowrap">{getJobTitle(applicant.appliedJobId)}</td>
                                            <td className="td-style table-cell-nowrap">{applicant.appliedDate}</td>
                                            <td className="td-style table-cell-nowrap">
                                                <Select value={applicant.status} onChange={(e) => handleStatusChange(applicant.id, e.target.value)} className="p-1 text-xs w-24">
                                                    {applicantStatuses.map(s => <option key={s} value={s}>{s}</option>)}
                                                </Select>
                                            </td>
                                            <td className="td-style table-cell-nowrap">
                                                <div className="flex space-x-2">
                                                    <button onClick={() => handleEdit(applicant)} className="text-blue-600 hover:text-blue-800"><Icon name="edit" size={16} /></button>
                                                    <button onClick={() => handleDelete(applicant.id)} className="text-red-600 hover:text-red-800"><Icon name="trash-2" size={16} /></button>
                                                </div>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                        {applicants.length === 0 && <div className="text-center py-12 text-gray-500">등록된 지원자가 없습니다.</div>}
                        {applicants.length > 0 && filteredApplicants.length === 0 && <div className="text-center py-12 text-gray-500">필터 결과와 일치하는 지원자가 없습니다.</div>}
                    </div>
                </div>
            );
        };

        // --- 조회수 업데이트 ---
        const DailyUpdate = ({ jobs, dailyRecords, loadData }) => {
            const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
            const [viewInputs, setViewInputs] = useState({});
            const [previousViews, setPreviousViews] = useState({});
            const [recordsForDate, setRecordsForDate] = useState({});
            const [isSaving, setIsSaving] = useState(false);

            const activeJobs = useMemo(() => jobs.filter(j => j.status === '진행중'), [jobs]);

            useEffect(() => {
                const recordsBefore = dailyRecords.filter(r => r.date < selectedDate);
                const recordsOn = dailyRecords.filter(r => r.date === selectedDate);
                const newPrevViews = {}, newCurrentViews = {}, newRecordsForDate = {};

                for (const job of activeJobs) {
                    const jobRecordsBefore = recordsBefore.filter(r => r.jobId === job.id);
                    const jobRecordsOn = recordsOn.filter(r => r.jobId === job.id);
                    const prevTotalViews = jobRecordsBefore.reduce((sum, r) => sum + (r.viewsIncrease || 0), 0);
                    const increaseOnDate = jobRecordsOn.reduce((sum, r) => sum + (r.viewsIncrease || 0), 0);
                    newPrevViews[job.id] = prevTotalViews;
                    newCurrentViews[job.id] = prevTotalViews + increaseOnDate;
                    newRecordsForDate[job.id] = jobRecordsOn.map(r => r.id);
                }
                setPreviousViews(newPrevViews);
                setViewInputs(newCurrentViews);
                setRecordsForDate(newRecordsForDate);
            }, [selectedDate, dailyRecords, activeJobs]);

            const handleChange = (jobId, value) => {
                setViewInputs(prev => ({ ...prev, [jobId]: value === '' ? '' : (parseInt(value) || 0) }));
            };

            const handleSubmit = async () => {
                setIsSaving(true);
                try {
                    const batch = db.batch();
                    for (const [jobId, currentViewInput] of Object.entries(viewInputs)) {
                        const recordsToDelete = recordsForDate[jobId] || [];
                        recordsToDelete.forEach(docId => batch.delete(db.collection('dailyRecords').doc(docId)));
                        const prevTotal = previousViews[jobId] || 0;
                        const currentTotal = currentViewInput || 0;
                        const increase = currentTotal - prevTotal;
                        if (increase !== 0) {
                            const docRef = db.collection('dailyRecords').doc();
                            batch.set(docRef, { jobId, date: selectedDate, viewsIncrease: increase, createdAt: new Date().toISOString() });
                        }
                    }
                    await batch.commit();
                    alert('조회수가 저장되었습니다!');
                    loadData();
                } catch (error) { alert('저장 실패: ' + error.message); }
                finally { setIsSaving(false); }
            };

            return (
                <div className="p-4 md:p-8">
                    <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-8">
                        <div>
                            <h2 className="text-2xl md:text-3xl font-bold text-gray-800 mb-4">조회수 업데이트</h2>
                            <div className="flex items-center space-x-4">
                                <label className="font-medium text-gray-700">날짜:</label>
                                <Input type="date" value={selectedDate} onChange={(e) => setSelectedDate(e.target.value)} />
                            </div>
                        </div>
                        {activeJobs.length > 0 && (
                            <Button onClick={handleSubmit} disabled={isSaving} variant="primary" className="mt-4 md:mt-0 w-full md:w-auto">
                                {isSaving ? '저장 중...' : '조회수 저장'}
                            </Button>
                        )}
                    </div>
                    <div className="space-y-4 mb-8">
                        {activeJobs.map(job => (
                            <div key={job.id} className="bg-white rounded-xl shadow-lg p-6">
                                <div className="mb-4">
                                    <h3 className="text-lg font-semibold text-gray-800">{job.title}</h3>
                                    <p className="text-sm text-gray-600">{job.site} | {job.position}</p>
                                </div>
                                <div>
                                    <label className="label-style mb-1">조회수 (누적)</label>
                                    <Input type="number" min="0" value={viewInputs[job.id] ?? ''} onChange={(e) => handleChange(job.id, e.target.value)} className="w-full md:w-1/3" placeholder="0" />
                                    <p className="text-xs text-gray-500 mt-1">(어제까지 누적: {previousViews[job.id] || 0})</p>
                                </div>
                            </div>
                        ))}
                    </div>
                    {activeJobs.length === 0 && <div className="text-center py-12 text-gray-500">진행중인 공고가 없습니다.</div>}
                </div>
            );
        };

        // --- 사이트 비교 ---
        const SiteComparison = ({ jobs, applicants, dailyRecords }) => {
            const sites = ['사람인', '잡코리아', '인크루트'];

            const siteData = useMemo(() => {
                return sites.map(site => {
                    const siteJobs = jobs.filter(j => j.site === site);
                    const jobIds = siteJobs.map(j => j.id);

                    const siteRecords = dailyRecords.filter(r => jobIds.includes(r.jobId));
                    const totalViews = siteRecords.reduce((sum, r) => sum + (r.viewsIncrease || 0), 0);

                    const siteApplicants = applicants.filter(a => jobIds.includes(a.appliedJobId));
                    const totals = { site, jobs: siteJobs.length, views: totalViews, applications: 0, contacts: 0, interviews: 0, offers: 0, hires: 0 };
                    siteApplicants.forEach(a => {
                        totals.applications++;
                        if (['면접', '합격', '입사'].includes(a.status)) totals.interviews++;
                        if (['합격', '입사'].includes(a.status)) totals.offers++;
                        if (a.status === '입사') totals.hires++;
                    });
                    totals.conversionRate = totals.applications > 0 ? ((totals.hires / totals.applications) * 100).toFixed(1) : 0;
                    return totals;
                });
            }, [jobs, applicants, dailyRecords]);

            const chartData = {
                labels: siteData.map(d => d.site),
                datasets: [
                    { label: '지원자', data: siteData.map(d => d.applications), backgroundColor: 'rgba(59, 130, 246, 0.8)' },
                    { label: '면접', data: siteData.map(d => d.interviews), backgroundColor: 'rgba(139, 92, 246, 0.8)' },
                    { label: '입사자', data: siteData.map(d => d.hires), backgroundColor: 'rgba(16, 185, 129, 0.8)' }
                ]
            };

            return (
                <div className="p-4 md:p-8">
                    <h2 className="text-2xl md:text-3xl font-bold text-gray-800 mb-8">사이트 비교</h2>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        {siteData.map(data => (
                            <div key={data.site} className="bg-white rounded-xl shadow-lg p-6">
                                <h3 className="text-xl font-bold text-center mb-6 text-blue-600">{data.site}</h3>
                                <div className="space-y-3">
                                    <div className="stat-item"><span className="stat-label">공고 수</span><span className="stat-value">{data.jobs}</span></div>
                                    <div className="stat-item"><span className="stat-label">조회수</span><span className="stat-value">{data.views}</span></div>
                                    <div className="stat-item"><span className="stat-label">지원자</span><span className="stat-value">{data.applications}</span></div>
                                    <div className="stat-item"><span className="stat-label">면접</span><span className="stat-value">{data.interviews}</span></div>
                                    <div className="stat-item"><span className="stat-label">합격자</span><span className="stat-value">{data.offers}</span></div>
                                    <div className="stat-item"><span className="stat-label">입사자</span><span className="stat-value text-green-600">{data.hires}</span></div>
                                    <div className="flex justify-between items-center pt-2"><span className="text-gray-600 font-semibold">전환율</span><span className="text-2xl font-bold text-blue-600">{data.conversionRate}%</span></div>
                                </div>
                            </div>
                        ))}
                    </div>
                    <div className="bg-white rounded-xl shadow-lg p-6">
                        <h3 className="text-xl font-semibold mb-4">사이트별 비교 차트</h3>
                        <div style={{ height: '350px' }}>
                            <ChartComponent type="bar" data={chartData} options={{ scales: { y: { beginAtZero: true } } }} />
                        </div>
                    </div>
                </div>
            );
        };

        // --- 효율성 분석 ---
        const EfficiencyAnalysis = ({ jobs, applicants, siteSettings }) => {
            const analysisData = useMemo(() => {
                const sites = ['사람인', '잡코리아', '인크루트'];
                return sites.map(site => {
                    const siteJobs = jobs.filter(j => j.site === site);
                    const jobIds = siteJobs.map(j => j.id);
                    const settings = siteSettings.find(s => s.site === site);
                    const siteApplicants = applicants.filter(a => jobIds.includes(a.appliedJobId));
                    const totals = { applications: 0, contacts: 0, interviews: 0, offers: 0, hires: 0 };
                    siteApplicants.forEach(a => {
                        totals.applications++;
                        if (['면접', '합격', '입사'].includes(a.status)) totals.interviews++;
                        if (['합격', '입사'].includes(a.status)) totals.offers++;
                        if (a.status === '입사') totals.hires++;
                    });
                    const cost = settings?.monthlyCost || 0;
                    const costPerHire = totals.hires > 0 ? (cost / totals.hires).toFixed(0) : 0;
                    const rates = {
                        interviewFromAppRate: totals.applications > 0 ? ((totals.interviews / totals.applications) * 100).toFixed(1) : 0,
                        offerFromInterviewRate: totals.interviews > 0 ? ((totals.offers / totals.interviews) * 100).toFixed(1) : 0,
                        hireFromOfferRate: totals.offers > 0 ? ((totals.hires / totals.offers) * 100).toFixed(1) : 0,
                        overallRate: totals.applications > 0 ? ((totals.hires / totals.applications) * 100).toFixed(1) : 0
                    };
                    return { site, ...totals, ...rates, cost, costPerHire, efficiency: parseFloat(rates.overallRate) - (cost / 100000) };
                });
            }, [jobs, applicants, siteSettings]);

            const sortedBySite = [...analysisData].sort((a, b) => b.overallRate - a.overallRate);

            return (
                <div className="p-4 md:p-8">
                    <h2 className="text-2xl md:text-3xl font-bold text-gray-800 mb-8">효율성 분석</h2>
                    <div className="bg-white rounded-xl shadow-lg p-6 mb-8">
                        <h3 className="text-xl font-semibold mb-6">단계별 전환율</h3>
                        <div className="space-y-6">
                            {analysisData.map(data => (
                                <div key={data.site} className="border-b pb-4 last:border-b-0">
                                    <h4 className="font-semibold text-lg mb-3">{data.site}</h4>
                                    <div className="grid grid-cols-2 md:grid-cols-3 gap-4 text-sm"> {/* 3칸으로 변경 */}
                                        <div><span className="text-gray-600">지원 → 면접</span><p className="rate-value text-blue-600">{data.interviewFromAppRate}%</p></div>
                                        <div><span className="text-gray-600">면접 → 합격</span><p className="rate-value text-purple-600">{data.offerFromInterviewRate}%</p></div>
                                        <div><span className="text-gray-600">합격 → 입사</span><p className="rate-value text-green-600">{data.hireFromOfferRate}%</p></div>
                                    </div>
                                    <div className="mt-3 pt-3 border-t"><span className="text-gray-600">총 전환율 (지원 → 입사)</span><p className="text-2xl font-bold text-blue-600">{data.overallRate}%</p></div>
                                </div>
                            ))}
                        </div>
                    </div>
                    <div className="bg-white rounded-xl shadow-lg p-6 mb-8">
                        <h3 className="text-xl font-semibold mb-6">비용 대비 효과 (ROI)</h3>
                        <div className="overflow-x-auto">
                            <table className="w-full">
                                <thead className="bg-gray-50"><tr><th className="th-style">사이트</th><th className="th-style">월 이용료</th><th className="th-style">입사자</th><th className="th-style">1인당 비용</th><th className="th-style">효율성 점수</th></tr></thead>
                                <tbody className="divide-y divide-gray-200">
                                    {analysisData.map(data => (
                                        <tr key={data.site} className="hover:bg-gray-50">
                                            <td className="td-style table-cell-nowrap">{data.site}</td><td className="td-style table-cell-nowrap">{data.cost.toLocaleString()}원</td><td className="td-style table-cell-nowrap">{data.hires}명</td>
                                            <td className="td-style table-cell-nowrap font-semibold text-blue-600">{data.costPerHire > 0 ? `${parseInt(data.costPerHire).toLocaleString()}원` : '-'}</td>
                                            <td className="td-style table-cell-nowrap"><span className={`badge-sm ${data.efficiency > 5 ? 'badge-green' : data.efficiency > 0 ? 'badge-yellow' : 'badge-red'}`}>{data.efficiency > 0 ? '높음' : data.efficiency > -5 ? '보통' : '낮음'}</span></td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div className="bg-white rounded-xl shadow-lg p-6">
                        <h3 className="text-xl font-semibold mb-6">사이트별 종합 순위</h3>
                        <div className="space-y-4">
                            {sortedBySite.map((data, index) => (
                                <div key={data.site} className="flex flex-col md:flex-row items-start md:items-center space-y-2 md:space-y-0 md:space-x-4 p-4 bg-gray-50 rounded-lg">
                                    <div className={`text-3xl font-bold ${index === 0 ? 'text-yellow-500' : index === 1 ? 'text-gray-400' : 'text-orange-600'}`}>{index + 1}</div>
                                    <div className="flex-1"><h4 className="font-semibold text-lg">{data.site}</h4><p className="text-sm text-gray-600">전환율 {data.overallRate}% | 입사자 {data.hires}명</p></div>
                                    <div className="text-left md:text-right w-full md:w-auto"><p className="text-sm text-gray-600">1인당 비용</p><p className="text-lg font-bold text-blue-600">{data.costPerHire > 0 ? `${parseInt(data.costPerHire).toLocaleString()}원` : '-'}</p></div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // --- 트렌드 분석 ---
        const TrendAnalysis = ({ jobs, dailyRecords, applicants }) => {
            const [period, setPeriod] = useState('week');
            const [startDate, setStartDate] = useState('');
            const [endDate, setEndDate] = useState('');

            const trendData = useMemo(() => {
                let filteredRecords = [...dailyRecords];
                let filteredApplicants = [...applicants];
                if (period !== 'all') {
                    let startDt, endDt = new Date();
                    if (period === 'custom' && startDate && endDate) {
                       startDt = new Date(startDate); endDt = new Date(endDate);
                    } else {
                        startDt = new Date();
                        let daysBack = 7;
                        if (period === 'month') daysBack = 30;
                        if (period === 'quarter') daysBack = 90;
                        startDt.setDate(endDt.getDate() - daysBack);
                    }
                    const startStr = startDt.toISOString().split('T')[0];
                    const endStr = endDt.toISOString().split('T')[0];
                    filteredRecords = filteredRecords.filter(r => r.date >= startStr && r.date <= endStr);
                    filteredApplicants = filteredApplicants.filter(a => a.appliedDate >= startStr && a.appliedDate <= endStr);
                }

                const dateMap = {};
                filteredRecords.forEach(record => {
                    if (!dateMap[record.date]) dateMap[record.date] = { date: record.date, views: 0, applications: 0, interviews: 0, offers: 0, hires: 0 };
                    dateMap[record.date].views += record.viewsIncrease || 0;
                });
                filteredApplicants.forEach(applicant => {
                    const date = applicant.appliedDate;
                    if (!dateMap[date]) dateMap[date] = { date: date, views: 0, applications: 0, interviews: 0, offers: 0, hires: 0 };
                    dateMap[date].applications++;
                    if (['면접', '합격', '입사'].includes(applicant.status)) dateMap[date].interviews++;
                    if (['합격', '입사'].includes(applicant.status)) dateMap[date].offers++;
                    if (applicant.status === '입사') dateMap[date].hires++;
                });
                return Object.values(dateMap).sort((a, b) => a.date.localeCompare(b.date));
            }, [dailyRecords, applicants, period, startDate, endDate]);

            const siteTrendData = useMemo(() => {
                const sites = ['사람인', '잡코리아', '인크루트'];
                return sites.map(site => {
                    const siteJobs = jobs.filter(j => j.site === site);
                    const jobIds = siteJobs.map(j => j.id);
                    const siteApplicants = applicants.filter(a => jobIds.includes(a.appliedJobId));
                    return { site, applications: siteApplicants.length };
                });
            }, [jobs, applicants]);

            const lineChartData = {
                labels: trendData.map(d => d.date),
                datasets: [
                    { label: '조회수', data: trendData.map(d => d.views), borderColor: 'rgb(59, 130, 246)', backgroundColor: 'rgba(59, 130, 246, 0.1)', tension: 0.4 },
                    { label: '지원자', data: trendData.map(d => d.applications), borderColor: 'rgb(16, 185, 129)', backgroundColor: 'rgba(16, 185, 129, 0.1)', tension: 0.4 },
                    { label: '면접', data: trendData.map(d => d.interviews), borderColor: 'rgb(139, 92, 246)', backgroundColor: 'rgba(139, 92, 246, 0.1)', tension: 0.4 },
                    { label: '입사자', data: trendData.map(d => d.hires), borderColor: 'rgb(245, 158, 11)', backgroundColor: 'rgba(245, 158, 11, 0.1)', tension: 0.4 }
                ]
            };

            const pieChartData = {
                labels: siteTrendData.map(d => d.site),
                datasets: [{ data: siteTrendData.map(d => d.applications), backgroundColor: ['rgba(59, 130, 246, 0.8)', 'rgba(16, 185, 129, 0.8)', 'rgba(245, 158, 11, 0.8)'] }]
            };

            return (
                <div className="p-4 md:p-8">
                    <h2 className="text-2xl md:text-3xl font-bold text-gray-800 mb-8">트렌드 분석</h2>
                    <div className="bg-white rounded-xl shadow-lg p-6 mb-8">
                        <div className="flex flex-wrap items-center gap-4">
                            <div className="flex flex-wrap gap-2">
                                <button onClick={() => setPeriod('week')} className={`btn-period ${period === 'week' ? 'btn-period-active' : ''}`}>최근 1주일</button>
                                <button onClick={() => setPeriod('month')} className={`btn-period ${period === 'month' ? 'btn-period-active' : ''}`}>최근 1개월</button>
                                <button onClick={() => setPeriod('quarter')} className={`btn-period ${period === 'quarter' ? 'btn-period-active' : ''}`}>최근 3개월</button>
                                <button onClick={() => setPeriod('custom')} className={`btn-period ${period === 'custom' ? 'btn-period-active' : ''}`}>기간 선택</button>
                            </div>
                            {period === 'custom' && (
                                <div className="flex items-center space-x-2">
                                    <Input type="date" value={startDate} onChange={(e) => setStartDate(e.target.value)} className="py-2" />
                                    <span>~</span>
                                    <Input type="date" value={endDate} onChange={(e) => setEndDate(e.target.value)} className="py-2" />
                                </div>
                            )}
                        </div>
                    </div>
                    <div className="bg-white rounded-xl shadow-lg p-6 mb-8">
                        <h3 className="text-xl font-semibold mb-4">일별 채용 단계 추이</h3>
                        <div style={{ height: '350px' }}> <ChartComponent type="line" data={lineChartData} options={{ scales: { y: { beginAtZero: true } } }} /> </div>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div className="bg-white rounded-xl shadow-lg p-6">
                            <h3 className="text-xl font-semibold mb-4">사이트별 지원자 비율</h3>
                            <div style={{ height: '280px' }}> <ChartComponent type="pie" data={pieChartData} /> </div>
                        </div>
                        <div className="bg-white rounded-xl shadow-lg p-6">
                            <h3 className="text-xl font-semibold mb-4">누적 데이터 (총 지원자)</h3>
                            <div className="space-y-4">
                                {siteTrendData.map((data, index) => (
                                    <div key={data.site} className="flex items-center justify-between">
                                        <div className="flex items-center space-x-3">
                                            <div className="w-4 h-4 rounded-full" style={{ backgroundColor: pieChartData.datasets[0].backgroundColor[index] }} />
                                            <span className="font-medium">{data.site}</span>
                                        </div>
                                        <span className="text-xl font-bold">{data.applications}명</span>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- 설정 ---
        const Settings = ({ siteSettings, goals, loadData }) => {
            const [activeTab, setActiveTab] = useState('sites');
            const [siteForm, setSiteForm] = useState({ site: '사람인', monthlyCost: 0, quarterlyCost: 0, startDate: '' });
            const [goalForm, setGoalForm] = useState({ yearMonth: '', targetHires: 0, targetSaramin: 0, targetJobkorea: 0, targetIncruit: 0 });

            useEffect(() => {
                if (activeTab === 'sites') {
                    const existing = siteSettings.find(s => s.site === '사람인');
                    setSiteForm(existing || { site: '사람인', monthlyCost: 0, quarterlyCost: 0, startDate: '' });
                } else if (activeTab === 'goals') {
                    const today = new Date().toISOString().substring(0, 7);
                    const existing = goals.find(g => g.yearMonth === today);
                    setGoalForm(existing || { yearMonth: today, targetHires: 0, targetSaramin: 0, targetJobkorea: 0, targetIncruit: 0 });
                }
            }, [activeTab, siteSettings, goals]);

            const handleSiteSubmit = async (e) => {
                e.preventDefault();
                try {
                    const existing = siteSettings.find(s => s.site === siteForm.site);
                    const data = { ...siteForm, monthlyCost: Number(siteForm.monthlyCost), quarterlyCost: Number(siteForm.quarterlyCost) }; // 숫자로 변환
                    if (existing) await db.collection('siteSettings').doc(existing.id).update(data);
                    else await db.collection('siteSettings').add(data);
                    alert('저장되었습니다!'); loadData();
                } catch (error) { alert('저장 실패: ' + error.message); }
            };

            const handleGoalSubmit = async (e) => {
                e.preventDefault();
                try {
                    const existing = goals.find(g => g.yearMonth === goalForm.yearMonth);
                     const data = { // 숫자로 변환
                        ...goalForm,
                        targetHires: Number(goalForm.targetHires), targetSaramin: Number(goalForm.targetSaramin),
                        targetJobkorea: Number(goalForm.targetJobkorea), targetIncruit: Number(goalForm.targetIncruit)
                    };
                    if (existing) await db.collection('goals').doc(existing.id).update(data);
                    else await db.collection('goals').add(data);
                    alert('저장되었습니다!'); loadData();
                } catch (error) { alert('저장 실패: ' + error.message); }
            };

            return (
                <div className="p-4 md:p-8">
                    <h2 className="text-2xl md:text-3xl font-bold text-gray-800 mb-8">설정</h2>
                    <div className="flex space-x-2 mb-6">
                        <button onClick={() => setActiveTab('sites')} className={`btn-tab ${activeTab === 'sites' ? 'btn-tab-active' : ''}`}>사이트 이용료</button>
                        <button onClick={() => setActiveTab('goals')} className={`btn-tab ${activeTab === 'goals' ? 'btn-tab-active' : ''}`}>목표 설정</button>
                    </div>

                    {activeTab === 'sites' && (
                        <div className="bg-white rounded-xl shadow-lg p-6">
                            <h3 className="text-xl font-semibold mb-6">사이트 이용료 설정</h3>
                            <form onSubmit={handleSiteSubmit} className="space-y-4 max-w-2xl">
                                <div>
                                    <label className="label-style">채용 사이트</label>
                                    <Select value={siteForm.site} onChange={(e) => {
                                        const site = e.target.value;
                                        const existing = siteSettings.find(s => s.site === site);
                                        setSiteForm(existing || { site, monthlyCost: 0, quarterlyCost: 0, startDate: '' });
                                    }}> <option>사람인</option> <option>잡코리아</option> <option>인크루트</option> </Select>
                                </div>
                                <div><label className="label-style">월 이용료 (원)</label><Input type="number" value={siteForm.monthlyCost} onChange={(e) => setSiteForm({...siteForm, monthlyCost: e.target.value})} /></div>
                                <div><label className="label-style">분기 이용료 (원)</label><Input type="number" value={siteForm.quarterlyCost} onChange={(e) => setSiteForm({...siteForm, quarterlyCost: e.target.value})} /></div>
                                <div><label className="label-style">과금 시작일</label><Input type="date" value={siteForm.startDate} onChange={(e) => setSiteForm({...siteForm, startDate: e.target.value})} /></div>
                                <Button type="submit" variant="primary" className="w-full">저장</Button>
                            </form>
                            <div className="mt-8">
                                <h4 className="font-semibold mb-4">현재 설정</h4>
                                <div className="space-y-3">
                                    {siteSettings.map(setting => (
                                        <div key={setting.id} className="border border-gray-200 rounded-lg p-4">
                                            <h5 className="font-semibold text-lg">{setting.site}</h5>
                                            <p className="text-sm text-gray-600 mt-1">월 {setting.monthlyCost?.toLocaleString()}원 / 분기 {setting.quarterlyCost?.toLocaleString()}원</p>
                                            {setting.startDate && <p className="text-sm text-gray-600">시작일: {setting.startDate}</p>}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}

                    {activeTab === 'goals' && (
                        <div className="bg-white rounded-xl shadow-lg p-6">
                            <h3 className="text-xl font-semibold mb-6">월별 목표 설정</h3>
                            <form onSubmit={handleGoalSubmit} className="space-y-4 max-w-2xl">
                                <div>
                                    <label className="label-style">년월</label>
                                    <Input type="month" value={goalForm.yearMonth} onChange={(e) => {
                                        const yearMonth = e.target.value;
                                        const existing = goals.find(g => g.yearMonth === yearMonth);
                                        setGoalForm(existing || { yearMonth, targetHires: 0, targetSaramin: 0, targetJobkorea: 0, targetIncruit: 0 });
                                    }} required />
                                </div>
                                <div><label className="label-style">월 채용 목표 인원</label><Input type="number" value={goalForm.targetHires} onChange={(e) => setGoalForm({...goalForm, targetHires: e.target.value})} /></div>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div><label className="label-style">사람인 목표</label><Input type="number" value={goalForm.targetSaramin} onChange={(e) => setGoalForm({...goalForm, targetSaramin: e.target.value})} /></div>
                                    <div><label className="label-style">잡코리아 목표</label><Input type="number" value={goalForm.targetJobkorea} onChange={(e) => setGoalForm({...goalForm, targetJobkorea: e.target.value})} /></div>
                                    <div><label className="label-style">인크루트 목표</label><Input type="number" value={goalForm.targetIncruit} onChange={(e) => setGoalForm({...goalForm, targetIncruit: e.target.value})} /></div>
                                </div>
                                <Button type="submit" variant="primary" className="w-full">저장</Button>
                            </form>
                            <div className="mt-8">
                                <h4 className="font-semibold mb-4">설정된 목표</h4>
                                <div className="space-y-3">
                                    {goals.sort((a,b) => b.yearMonth.localeCompare(a.yearMonth)).map(goal => (
                                        <div key={goal.id} className="border border-gray-200 rounded-lg p-4">
                                            <h5 className="font-semibold text-lg mb-2">{goal.yearMonth}</h5>
                                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                                                <div><span className="text-gray-600">총 목표</span><p className="goal-value text-blue-600">{goal.targetHires}명</p></div>
                                                <div><span className="text-gray-600">사람인</span><p className="goal-value">{goal.targetSaramin}명</p></div>
                                                <div><span className="text-gray-600">잡코리아</span><p className="goal-value">{goal.targetJobkorea}명</p></div>
                                                <div><span className="text-gray-600">인크루트</span><p className="goal-value">{goal.targetIncruit}명</p></div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- Helper Components & Styles ---
        const Input = ({ className, ...props }) => <input className={`input-style ${className}`} {...props} />;
        const Select = ({ className, ...props }) => <select className={`input-style bg-white ${className}`} {...props} />;
        const Textarea = ({ className, ...props }) => <textarea className={`input-style ${className}`} {...props} />;
        const Button = ({ variant = 'primary', className, children, ...props }) => {
            const baseStyle = "px-6 py-2 rounded-lg font-semibold transition-colors shadow disabled:opacity-50 text-sm md:text-base md:py-3"; // 패딩 조정
            const variants = { primary: "bg-blue-600 text-white hover:bg-blue-700", secondary: "bg-gray-300 text-gray-700 hover:bg-gray-400", danger: "bg-red-600 text-white hover:bg-red-700" };
            return <button className={`${baseStyle} ${variants[variant]} ${className}`} {...props}>{children}</button>;
        };

        // 전역 스타일 추가 (input, label, table, badge, tab 등)
        const GlobalStyles = () => (
            <style>{`
                .input-style { display: block; width: 100%; padding: 0.5rem 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; box-shadow: inset 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
                .input-style:focus { outline: 2px solid transparent; outline-offset: 2px; border-color: #3b82f6; box-shadow: 0 0 0 2px #bfdbfe; }
                .label-style { display: block; margin-bottom: 0.25rem; font-size: 0.875rem; font-weight: 500; color: #374151; }
                .btn-primary { background-color: #2563eb; color: white; padding: 0.6rem 1.2rem; border-radius: 0.375rem; font-weight: 600; transition: background-color 0.2s; box-shadow: 0 1px 3px 0 rgba(0,0,0,.1), 0 1px 2px 0 rgba(0,0,0,.06); }
                .btn-primary:hover { background-color: #1d4ed8; } .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
                .btn-secondary { background-color: #d1d5db; color: #374151; padding: 0.6rem 1.2rem; border-radius: 0.375rem; font-weight: 600; transition: background-color 0.2s; box-shadow: 0 1px 3px 0 rgba(0,0,0,.1), 0 1px 2px 0 rgba(0,0,0,.06); }
                .btn-secondary:hover { background-color: #9ca3af; }
                .th-style { padding: 0.75rem 1rem; text-align: left; font-size: 0.75rem; font-weight: 500; color: #6b7280; text-transform: uppercase; }
                .td-style { padding: 0.75rem 1rem; font-size: 0.875rem; }
                .badge-blue { background-color: #dbeafe; color: #1e40af; padding: 0.25rem 0.5rem; font-size: 0.75rem; font-weight: 600; border-radius: 9999px; }
                .badge-green { background-color: #d1fae5; color: #065f46; padding: 0.25rem 0.5rem; font-size: 0.75rem; font-weight: 600; border-radius: 9999px; }
                .badge-yellow { background-color: #fef3c7; color: #92400e; padding: 0.25rem 0.5rem; font-size: 0.75rem; font-weight: 600; border-radius: 9999px; }
                .badge-red { background-color: #fee2e2; color: #991b1b; padding: 0.25rem 0.5rem; font-size: 0.75rem; font-weight: 600; border-radius: 9999px; }
                .badge-gray { background-color: #f3f4f6; color: #374151; padding: 0.25rem 0.5rem; font-size: 0.75rem; font-weight: 600; border-radius: 9999px; }
                .badge-sm { padding: 0.25rem 0.75rem; font-size: 0.875rem; font-weight: 600; border-radius: 9999px; } /* 효율성 점수용 */
                .btn-tab { padding: 0.75rem 1.5rem; border-radius: 0.375rem; transition: background-color 0.2s, color 0.2s; }
                .btn-tab-active { background-color: #2563eb; color: white; }
                .stat-item { display: flex; justify-content: space-between; align-items: center; padding-bottom: 0.5rem; border-bottom: 1px solid #e5e7eb; }
                .stat-label { color: #6b7280; } .stat-value { font-size: 1.125rem; font-weight: 700; }
                .rate-value { font-size: 1.25rem; font-weight: 700; } /* 효율성 분석용 */
                .goal-value { font-size: 1.25rem; font-weight: 700; } /* 목표 설정용 */
                .btn-period { padding: 0.5rem 1rem; border-radius: 0.375rem; transition: background-color 0.2s, color 0.2s; background-color: #f3f4f6; color: #374151; }
                .btn-period:hover { background-color: #e5e7eb; }
                .btn-period-active { background-color: #2563eb; color: white; }
            `}</style>
        );

        ReactDOM.render(<> <GlobalStyles /> <App /> </>, document.getElementById('root'));
    </script>
</body>
</html>
