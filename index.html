<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>채용 현황 관리 시스템</title>
    <!-- React 및 라이브러리 -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- 스타일 -->
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
        .icon {
            display: inline-block;
            width: 24px;
            height: 24px;
            vertical-align: middle;
        }
        /* 모달 트랜지션용 */
        .modal-enter { opacity: 0; transform: scale(0.95); }
        .modal-enter-active { opacity: 1; transform: scale(1); transition: all 200ms ease-out; }
        .modal-exit { opacity: 1; transform: scale(1); }
        .modal-exit-active { opacity: 0; transform: scale(0.95); transition: all 200ms ease-in; }

        /* 사이드바 트랜지션 */
        .sidebar {
            transition: transform 0.3s ease-in-out;
        }
        /* 테이블 셀 줄바꿈 방지 */
        .table-cell-nowrap {
            white-space: nowrap;
        }
        /* 지원자 관리 필터 너비 */
        .filter-select {
            min-width: 120px;
        }
        /* 레이더 차트 컨테이너 */
        .radar-chart-container {
            position: relative;
            height: 400px; /* 필요에 따라 조절 */
            width: 100%;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <!-- 
      1. 공통 컴포넌트 로드 (components)
      (의존성 순서에 맞게 정렬)
    -->
    <script type="text/babel" src="components/Icon.js"></script>
    <script type="text/babel" src="components/UI.js"></script> 
    <script type="text/babel" src="components/ChartComponent.js"></script>
    <script type="text/babel" src="components/Login.js"></script>
    <script type="text/babel" src="components/KPICard.js"></script>
    <script type="text/babel" src="components/ConversionStep.js"></script>
    <script type="text/babel" src="components/Sidebar.js"></script>
    <script type="text/babel" src="components/DashboardSettingsModal.js"></script>
    <script type="text/babel" src="components/JobDetailModal.js"></script>
    <script type="text/babel" src="components/SiteSummary.js"></script>

    <!-- 
      2. 페이지 컴포넌트 로드 (pages)
      (페이지 간 의존성은 없으나, Dashboard를 맨 위에 두는 것이 일반적)
    -->
    <script type="text/babel" src="pages/Dashboard.js"></script>
    <script type="text/babel" src="pages/JobManagement.js"></script>
    <script type="text/babel" src="pages/ApplicantManagement.js"></script>
    <script type="text/babel" src="pages/DailyUpdate.js"></script>
    <script type="text/babel" src="pages/SiteComparison.js"></script>
    <script type="text/babel" src="pages/EfficiencyAnalysis.js"></script>
    <script type="text/babel" src="pages/TrendAnalysis.js"></script>
    <script type="text/babel" src="pages/Settings.js"></script>

    <!-- 
      3. 메인 애플리케이션 스크립트
    -->
    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useCallback } = React;

        // Firebase 초기화
        let db = null;
        let auth = null;
        const initFirebase = (config) => {
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(config);
                }
                db = firebase.firestore();
                auth = firebase.auth();
                return true;
            } catch (error) {
                console.error("Firebase 초기화 오류:", error);
                return false;
            }
        };

        // --- 메인 앱 ---
        const App = () => {
            const [user, setUser] = useState(null);
            const [authLoading, setAuthLoading] = useState(true);

            const [currentPage, setCurrentPage] = useState('dashboard');
            const [jobs, setJobs] = useState([]);
            const [dailyRecords, setDailyRecords] = useState([]);
            const [applicants, setApplicants] = useState([]);
            const [siteSettings, setSiteSettings] = useState([]);
            const [goals, setGoals] = useState([]);
            const [loading, setLoading] = useState(true);

            const [isSidebarOpen, setIsSidebarOpen] = useState(false);

            useEffect(() => {
                // --- Firebase 설정 직접 입력 ---
                // 보안을 위해 실제 키는 환경 변수 등으로 관리하는 것이 좋습니다.
                const firebaseConfig = {
                  apiKey: "AIzaSyAObneOsBpf4up7PRQLx6KUM_ixvuZqcUQ",
                  authDomain: "recruitment-system-8f83c.firebaseapp.com",
                  projectId: "recruitment-system-8f83c",
                  storageBucket: "recruitment-system-8f83c.appspot.com",
                  messagingSenderId: "627405471475",
                  appId: "1:627405471475:web:8bbbf4d4b6302671190186"
                };

                const success = initFirebase(firebaseConfig);

                if (success) {
                    const unsubscribe = auth.onAuthStateChanged(firebaseUser => {
                        if (firebaseUser) {
                            setUser(firebaseUser);
                            loadData(); // 로그인 시 데이터 로드
                        } else {
                            setUser(null);
                            // 로그아웃 시 데이터 초기화
                            setJobs([]); setDailyRecords([]); setApplicants([]);
                            setSiteSettings([]); setGoals([]);
                        }
                        setAuthLoading(false);
                    });
                    return () => unsubscribe(); // 컴포넌트 언마운트 시 리스너 정리
                } else {
                    console.error("Firebase 초기화 실패!");
                    // 사용자에게 알림 (alert 대신 더 나은 UI 사용 가능)
                    // alert("Firebase 초기화에 실패했습니다. 코드를 확인해주세요.");
                    setAuthLoading(false);
                    setLoading(false);
                }
            }, []); // 앱 마운트 시 1회만 실행

            const handleLogin = () => {
                 setAuthLoading(true); // 로그인 시도 시 로딩 상태로 변경
            }

            // 데이터 로드 함수 (개선됨 - 필요한 것만 로드)
const loadData = useCallback(async (collections = ['all']) => {
    if (!auth.currentUser) return;
    
    try {
        const promises = [];
        const collectionMap = {
            jobs: () => db.collection('jobs').get(),
            dailyRecords: () => db.collection('dailyRecords').get(),
            applicants: () => db.collection('applicants').orderBy('appliedDate', 'desc').get(),
            siteSettings: () => db.collection('siteSettings').get(),
            goals: () => db.collection('goals').get()
        };

        // 'all'이 포함되어 있으면 모든 데이터 로드
        if (collections.includes('all')) {
            collections = Object.keys(collectionMap);
        }

        // 필요한 컬렉션만 로드
        const results = {};
        for (const collection of collections) {
            if (collectionMap[collection]) {
                results[collection] = await collectionMap[collection]();
            }
        }

        // 상태 업데이트
        if (results.jobs) {
            setJobs(results.jobs.docs.map(doc => ({ id: doc.id, ...doc.data() })));
        }
        if (results.dailyRecords) {
            setDailyRecords(results.dailyRecords.docs.map(doc => ({ id: doc.id, ...doc.data() })));
        }
        if (results.applicants) {
            setApplicants(results.applicants.docs.map(doc => ({ id: doc.id, ...doc.data() })));
        }
        if (results.siteSettings) {
            setSiteSettings(results.siteSettings.docs.map(doc => ({ id: doc.id, ...doc.data() })));
        }
        if (results.goals) {
            setGoals(results.goals.docs.map(doc => ({ id: doc.id, ...doc.data() })));
        }

    } catch (error) {
        console.error("데이터 로드 오류:", error);
        alert('데이터 로드에 실패했습니다: ' + error.message);
    } finally {
        setLoading(false);
    }
}, []);


            // 1. 인증 로딩 중
            if (authLoading) {
                 return (
                    <div className="min-h-screen flex items-center justify-center">
                        <div className="text-center">
                            <div className="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-600 mx-auto mb-4"></div>
                            <p className="text-gray-600">인증 확인 중...</p>
                        </div>
                    </div>
                 );
            }

            // 2. 인증 실패 (로그인 안 됨)
            if (!user) {
                return <Login onLogin={handleLogin} />;
            }

            // 3. 인증 후 데이터 로딩 중 (초기 로딩)
            // loading은 useEffect에서 데이터 로드 후 false로 변경됨
            if (loading) {
                 return (
                     <div className="min-h-screen flex items-center justify-center">
                        <div className="text-center">
                            <div className="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-600 mx-auto mb-4"></div>
                            <p className="text-gray-600">데이터를 불러오는 중...</p>
                        </div>
                    </div>
                );
            }
            
            // 4. 로딩 완료, 앱 렌더링
            return (
                <div className="flex flex-col md:flex-row h-screen bg-gray-50 relative">
                    <Sidebar
                        currentPage={currentPage}
                        setCurrentPage={setCurrentPage}
                        user={user}
                        isSidebarOpen={isSidebarOpen}
                        setIsSidebarOpen={setIsSidebarOpen}
                    />
                    <div className="flex-1 overflow-auto">
                        {/* 모바일용 헤더 */}
                        <div className="sticky top-0 bg-white shadow-sm p-4 z-10 md:hidden flex justify-between items-center">
                            <h1 className="text-lg font-bold text-gray-800">
                                { currentPage === 'applicants' ? '지원자 관리' :
                                  currentPage === 'daily' ? '조회수 업데이트' :
                                  currentPage.charAt(0).toUpperCase() + currentPage.slice(1) }
                            </h1>
                            <button onClick={() => setIsSidebarOpen(true)} className="text-gray-600">
                                <Icon name="menu" size={28} />
                            </button>
                        </div>

                        {/* 페이지 라우팅: currentPage 상태에 따라 
                          미리 로드된 페이지 컴포넌트 중 하나를 렌더링합니다.
                        */}
                        {currentPage === 'dashboard' && <Dashboard jobs={jobs} dailyRecords={dailyRecords} applicants={applicants} siteSettings={siteSettings} goals={goals} />}
                        {currentPage === 'jobs' && <JobManagement jobs={jobs} applicants={applicants} loadData={loadData} />}
                        {currentPage === 'applicants' && <ApplicantManagement applicants={applicants} jobs={jobs} loadData={loadData} />}
                        {currentPage === 'daily' && <DailyUpdate jobs={jobs} dailyRecords={dailyRecords} loadData={loadData} />}
                        {currentPage === 'compare' && <SiteComparison jobs={jobs} applicants={applicants} dailyRecords={dailyRecords} />}
                        {currentPage === 'efficiency' && <EfficiencyAnalysis jobs={jobs} applicants={applicants} siteSettings={siteSettings} />}
                        {currentPage === 'trends' && <TrendAnalysis jobs={jobs} dailyRecords={dailyRecords} applicants={applicants} />}
                        {currentPage === 'settings' && <Settings siteSettings={siteSettings} goals={goals} loadData={loadData} />}
                    </div>
                </div>
            );
        };

        // --- 모든 페이지 컴포넌트가 외부 파일로 이동했습니다 ---
        
        // App 컴포넌트와 GlobalStyles를 DOM에 렌더링합니다.
        // GlobalStyles는 components/UI.js 안에 포함되어 있습니다.
        ReactDOM.render(<> <GlobalStyles /> <App /> </>, document.getElementById('root'));
    </script>
</body>
</html>


