<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>채용 현황 관리 시스템</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
        .icon {
            display: inline-block;
            width: 24px;
            height: 24px;
            vertical-align: middle;
        }
        /* ... (기존 스타일) ... */
        @media print {
            body * {
                visibility: hidden;
            }
            .report-print-area, .report-print-area * {
                visibility: visible;
            }
            .report-print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                padding: 1.5rem;
            }
            .no-print {
                display: none !important;
            }
            canvas {
                max-width: 100% !important;
            }
            .report-section {
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel" src="components/Icon.js"></script>
    <script type="text/babel" src="components/UI.js"></script> 
    <script type="text/babel" src="components/ChartComponent.js"></script>
    <script type="text/babel" src="components/Login.js"></script>
    <script type="text/babel" src="components/KPICard.js"></script>
    <script type="text/babel" src="components/ConversionStep.js"></script>
    <script type="text/babel" src="components/Sidebar.js"></script>
    <script type="text/babel" src="components/DashboardSettingsModal.js"></script>
    <script type="text/babel" src="components/JobDetailModal.js"></script>
    <script type="text/babel" src="components/SiteSummary.js"></script>

    <script type="text/babel" src="pages/Dashboard.js"></script>
    <script type="text/babel" src="pages/JobManagement.js"></script>
    <script type="text/babel" src="pages/ApplicantManagement.js"></script>
    <script type="text/babel" src="pages/DailyUpdate.js"></script>
    <script type="text/babel" src="pages/SiteComparison.js"></script>
    <script type="text/babel" src="pages/EfficiencyAnalysis.js"></script>
    <script type="text/babel" src="pages/TrendAnalysis.js"></script>
    <script type="text/babel" src="pages/Report.js"></script>
    <script type="text/babel" src="pages/Settings.js"></script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useCallback } = React;

        // Firebase 초기화
        let db = null;
        let auth = null;
        const initFirebase = (config) => {
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(config);
                }
                db = firebase.firestore();
                auth = firebase.auth();
                return true;
            } catch (error) {
                console.error("Firebase 초기화 오류:", error);
                return false;
            }
        };

        // --- ⬇️ (추가) 차트 플러그인 전역 등록 ⬇️ ---
        // (참고: ChartDataLabels는 위에서 로드한 스크립트를 통해 접근 가능)
        Chart.register(ChartDataLabels);
        // 기본적으로 모든 파이 차트에서 라벨 숨기기 (필요한 곳에서만 켜기)
        Chart.defaults.plugins.datalabels.display = false;
        // --- ⬆️ (추가) ⬆️ ---

        // --- 메인 앱 ---
        const App = () => {
            const [user, setUser] = useState(null);
            const [authLoading, setAuthLoading] = useState(true);

            const [currentPage, setCurrentPage] = useState('dashboard');
            const [jobs, setJobs] = useState([]);
            const [dailyRecords, setDailyRecords] = useState([]);
            const [applicants, setApplicants] = useState([]);
            const [siteSettings, setSiteSettings] = useState([]);
            const [goals, setGoals] = useState([]);
            const [loading, setLoading] = useState(true);

            const [isSidebarOpen, setIsSidebarOpen] = useState(false);

            useEffect(() => {
                const firebaseConfig = {
                  apiKey: "AIzaSyAObneOsBpf4up7PRQLx6KUM_ixvuZqcUQ",
                  authDomain: "recruitment-system-8f83c.firebaseapp.com",
                  projectId: "recruitment-system-8f83c",
                  storageBucket: "recruitment-system-8f83c.appspot.com",
                  messagingSenderId: "627405471475",
                  appId: "1:627405471475:web:8bbbf4d4b6302671190186"
                };

                const success = initFirebase(firebaseConfig);

                if (success) {
                    const unsubscribe = auth.onAuthStateChanged(firebaseUser => {
                        if (firebaseUser) {
                            setUser(firebaseUser);
                            loadData(); 
                        } else {
                            setUser(null);
                            setJobs([]); setDailyRecords([]); setApplicants([]);
                            setSiteSettings([]); setGoals([]);
                        }
                        setAuthLoading(false);
                    });
                    return () => unsubscribe();
                } else {
                    console.error("Firebase 초기화 실패!");
                    setAuthLoading(false);
                    setLoading(false);
                }
            }, []); 

            const handleLogin = () => {
                 setAuthLoading(true);
            }

            const loadData = useCallback(async () => {
                if (!auth.currentUser) return; 
                 
                try {
                    const [jobsSnapshot, recordsSnapshot, applicantsSnapshot, settingsSnapshot, goalsSnapshot] = await Promise.all([
                        db.collection('jobs').get(),
                        db.collection('dailyRecords').get(),
                        db.collection('applicants').orderBy('appliedDate', 'desc').get(),
                        db.collection('siteSettings').get(),
                        db.collection('goals').get()
                    ]);

                    setJobs(jobsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    setDailyRecords(recordsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    setApplicants(applicantsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    setSiteSettings(settingsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    setGoals(goalsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));

                } catch (error) {
                    console.error("데이터 로드 오류:", error);
                } finally {
                    if (loading) setLoading(false);
                }
            }, [loading]);


            // 1. 인증 로딩 중
            if (authLoading) {
                 return (
                    <div className="min-h-screen flex items-center justify-center">
                        <div className="text-center">
                            <div className="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-600 mx-auto mb-4"></div>
                            <p className="text-gray-600">인증 확인 중...</p>
                        </div>
                    </div>
                 );
            }

            // 2. 인증 실패 (로그인 안 됨)
            if (!user) {
                return <Login onLogin={handleLogin} />;
            }

            // 3. 인증 후 데이터 로딩 중 (초기 로딩)
            if (loading) {
                 return (
                     <div className="min-h-screen flex items-center justify-center">
                        <div className="text-center">
                            <div className="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-600 mx-auto mb-4"></div>
                            <p className="text-gray-600">데이터를 불러오는 중...</p>
                        </div>
                    </div>
                );
            }
            
            // 4. 로딩 완료, 앱 렌더링
            return (
                <div className="flex flex-col md:flex-row h-screen bg-gray-50 relative">
                    <Sidebar
                        currentPage={currentPage}
                        setCurrentPage={setCurrentPage}
                        user={user}
                        isSidebarOpen={isSidebarOpen}
                        setIsSidebarOpen={setIsSidebarOpen}
                    />
                    <div className="flex-1 overflow-auto">
                        {/* 모바일용 헤더 */}
                        <div className="sticky top-0 bg-white shadow-sm p-4 z-10 md:hidden flex justify-between items-center">
                            <h1 className="text-lg font-bold text-gray-800">
                                { currentPage === 'applicants' ? '지원자 관리' :
                                  currentPage === 'daily' ? '조회수 업데이트' :
                                  currentPage.charAt(0).toUpperCase() + currentPage.slice(1) }
                            </h1>
                            <button onClick={() => setIsSidebarOpen(true)} className="text-gray-600">
                                <Icon name="menu" size={28} />
                            </button>
                        </div>

                        {/* 페이지 라우팅 */}
                        {currentPage === 'dashboard' && <Dashboard jobs={jobs} dailyRecords={dailyRecords} applicants={applicants} siteSettings={siteSettings} goals={goals} />}
                        {currentPage === 'jobs' && <JobManagement jobs={jobs} applicants={applicants} loadData={loadData} />}
                        {currentPage === 'applicants' && <ApplicantManagement applicants={applicants} jobs={jobs} loadData={loadData} />}
                        {currentPage === 'daily' && <DailyUpdate jobs={jobs} dailyRecords={dailyRecords} loadData={loadData} />}
                        {currentPage === 'compare' && <SiteComparison jobs={jobs} applicants={applicants} dailyRecords={dailyRecords} />}
                        {currentPage === 'efficiency' && <EfficiencyAnalysis jobs={jobs} applicants={applicants} siteSettings={siteSettings} />}
                        {currentPage === 'trends' && <TrendAnalysis jobs={jobs} dailyRecords={dailyRecords} applicants={applicants} />}
                        {currentPage === 'report' && <Report jobs={jobs} dailyRecords={dailyRecords} applicants={applicants} siteSettings={siteSettings} />}
                        {currentPage === 'settings' && <Settings siteSettings={siteSettings} goals={goals} loadData={loadData} />}
                    </div>
                </div>
            );
        };

        // App 컴포넌트와 GlobalStyles를 DOM에 렌더링합니다.
        ReactDOM.render(<> <GlobalStyles /> <App /> </>, document.getElementById('root'));
    </script>
</body>
</html>
